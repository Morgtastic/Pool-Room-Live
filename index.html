<!-- FILE: index.html (replace fully) -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Pool Room â€” Live Board</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="./styles.css" rel="stylesheet" />

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
<script defer src="./js/supabaseClient.js?v=8"></script>



<script>
  // Delay the banner until SDK/client have had a chance to init
  (async () => {
    const wait = (ms) => new Promise(r => setTimeout(r, ms));
    let waited = 0;
    while (waited < 6000 && (!window.supabase || !window.sb || !sb.client)) {
      await wait(300);
      waited += 300;
    }
    if (!window.supabase) {
      const b = document.createElement('div');
      b.style.cssText="position:fixed;left:0;right:0;top:0;background:#b00020;color:#fff;padding:10px 14px;font:14px system-ui;z-index:99999";
      b.textContent="Supabase SDK missing. Check /vendor/supabase-global.js tag.";
      document.addEventListener('DOMContentLoaded',()=>document.body.appendChild(b));
    } else if (!window.sb || !sb.client) {
      const b = document.createElement('div');
      b.style.cssText="position:fixed;left:0;right:0;top:0;background:#b00020;color:#fff;padding:10px 14px;font:14px system-ui;z-index:99999";
      b.textContent="Supabase client missing. Check /js/supabaseClient.js and your anon key.";
      document.addEventListener('DOMContentLoaded',()=>document.body.appendChild(b));
    }
  })();
</script>


  <!-- Fail-fast banner if SDK/client missing (why: avoid silent "Loading Roomsâ€¦") -->
  <script>
    function banner(msg){
      var b=document.createElement('div');
      b.style.cssText="position:fixed;left:0;right:0;top:0;background:#b00020;color:#fff;padding:10px 14px;font:14px system-ui;z-index:99999";
      b.textContent=msg;
      document.addEventListener('DOMContentLoaded',()=>document.body.appendChild(b));
    }
    if (!window.supabase) banner("Supabase SDK missing. Ensure /vendor/supabase-global.js is included with type='module'.");
    if (!window.sb || !window.sb.client) banner("Supabase client missing. Ensure /js/supabaseClient.js loads after the SDK.");
  </script>
</head>
<body>
  <header class="topbar">
    <h1>Live Board</h1>
    <div class="row">
      <a class="link" href="./admin.html">Owner Dashboard</a>
    </div>
  </header>

  <main class="container">
    <div class="card">
      <h2>Status</h2>
      <div class="muted" id="legend">
        ðŸŸ¢ Open / No wait &nbsp;â€¢&nbsp; ðŸŸ¡ Moderate wait &nbsp;â€¢&nbsp; ðŸ”´ Full / Busy
      </div>
    </div>

    <div id="status-msg" class="muted mono" style="margin:8px 0">Loading Roomsâ€¦</div>
    <div id="rooms" class="vstack gap"></div>
  </main>

  <script>
  (function(){
    // Stop if SDK/client are missing; banners above explain.
    if (!window.supabase || !window.sb || !sb.client) return;

    const supabase = sb.client;
    const roomsEl  = document.getElementById('rooms');
    const msgEl    = document.getElementById('status-msg');

    const dotClass = (s) => sb.dotClass(s);
    const label    = (s) => `${sb.statusEmoji(s)} ${sb.statusLabel(s)}`;

    // Optional filter: /index.html?room=<public_slug>
    const params = new URLSearchParams(location.search);
    const filterSlug = params.get('room')?.trim() || null;

    function setMsg(t){ msgEl.textContent = t || ""; }
    function card(room){
      const div = document.createElement('div');
      div.className = 'card';
      div.dataset.roomId = room.id;
      div.innerHTML = `
        <div class="row between">
          <h3><span class="status-dot ${dotClass(room.status)}"></span> ${room.name}</h3>
          <span class="badge ${room.status}">${label(room.status)}</span>
        </div>
        <div class="updated">Updated: ${sb.formatTime(room.updated_at)}</div>
      `;
      return div;
    }

    function render(list){
      roomsEl.innerHTML = "";
      if (!list || list.length === 0) {
        setMsg(filterSlug ? "No matching room." : "No rooms yet.");
        return;
      }
      setMsg("");
      list.forEach(r => roomsEl.appendChild(card(r)));
    }

    async function load(){
      try {
        setMsg("Loading Roomsâ€¦");
        let q = supabase.from('rooms')
          .select('id,name,status,public_slug,updated_at')
          .order('name', { ascending: true });
        if (filterSlug) q = q.eq('public_slug', filterSlug);

        const { data, error } = await q;
        if (error) { setMsg("Error: " + error.message); console.error("[LiveBoard] SELECT error:", error); return; }
        render(data);
      } catch (e) {
        setMsg("Error: " + (e?.message || e));
        console.error("[LiveBoard] exception:", e);
